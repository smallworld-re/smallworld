name: Build Container
on:
  schedule:
    - cron: "00 3 * * *"
  workflow_dispatch:

env:
  REGISTRY: harbor.harbor.svc.cluster.local

jobs:
  Build-Container:
    runs-on: smallworld-arc
    steps:
      - name: Cleanup Shared
        run: find /home/runner/_shared -mindepth 1 -mtime +3 -exec rm {} \;

      - uses: actions/checkout@v3

      - name: Trust Registry Cert
        run: |
          echo "Fetching certificate from ${{ env.REGISTRY }}"
          openssl s_client -showcerts -connect ${{ env.REGISTRY }}:443 < /dev/null 2>/dev/null | openssl x509 -outform PEM | tee /usr/local/share/ca-certificates/harbor.crt > /dev/null
          update-ca-certificates

      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:master
            network=host
          buildkitd-config-inline: |
            [registry."${{ env.REGISTRY }}"]
              insecure = true
              http = true

      - name: Build Docker Image
        uses: docker/build-push-action@v6.18.0
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/smallworld/smallworld_ci:${{ github.sha }}
            ${{ env.REGISTRY }}/smallworld/smallworld_ci:latest
