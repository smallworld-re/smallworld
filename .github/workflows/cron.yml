name: Cron Jobs
on:
  schedule:
    - cron: "00 3 * * *"
  workflow_dispatch:

env:
  REGISTRY: harbor.harbor.svc.cluster.local

jobs:
  Build-Container:
    runs-on: smallworld-arc
    steps:
      - name: Cleanup Shared
        run: find /home/runner/_shared -mindepth 1 -mtime +3 -exec rm {} \;

      - name: Install docker
        run: |
          apt-get update -y
          apt-get install -y docker

      - name: Allow HTTP for the in-cluster registry
        run: |
          mkdir -p /etc/containers/registries.conf.d
          cat <<'EOF' | tee /etc/containers/registries.conf.d/50-smallworld.conf
          [[registry]]
          location = "${{ env.REGISTRY }}"
          insecure = true
          EOF

      - uses: actions/checkout@v3

      - name: Login to registry
        run: |
          docker login "$REGISTRY" -u "${{ secrets.REGISTRY_USER }}" -p "${{ secrets.REGISTRY_PASSWORD }}"

      - name: Build CI
        run: |
          docker build -f Dockerfile --network host --build-arg NIX_CACHE_PUBKEY=${{ secrets.NIX_CACHE_PUBKEY }} -t $REGISTRY/smallworld/smallworld_ci:${{ github.sha }} .

      - name: Tag CI
        run: |
          docker tag $REGISTRY/smallworld/smallworld_ci:${{ github.sha }} $REGISTRY/smallworld/smallworld_ci:latest

      - name: Push to Registry
        run: |
          docker push $REGISTRY/smallworld/smallworld_ci:${{ github.sha }}
          docker push $REGISTRY/smallworld/smallworld_ci:latest

  Update-Flake:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: DeterminateSystems/determinate-nix-action@v3
      - uses: DeterminateSystems/update-flake-lock@main
        with:
          pr-title: "chore: update nix flake inputs"
          token: ${{ secrets.PR_TOKEN }}
