name: Pull Request
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, edited]

env:
  TZ: UTC
  USER: root
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  Lint:
    runs-on: smallworld-arc
    permissions:
      contents: write
    outputs:
      changes_detected: ${{ steps.ac.outputs.changes_detected }}

    steps:
      - uses: cachix/cachix-action@v15
        with:
          name: smallworld
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          
      - name: Checkout
        uses: actions/checkout@v3
        env:
          bot_token: ${{ secrets.BOT_TOKEN }}
        if: ${{ env.bot_token != '' }}
        with:
          token: ${{ secrets.BOT_TOKEN }}

      - name: Cache inputs
        env:
          cachix_token: ${{ secrets.CACHIX_AUTH_TOKEN }}
        if: ${{ env.cachix_token != '' }}
        run: |
          nix run .#printInputsRecursive | cachix push smallworld

      - name: Build devshell
        run: |
          nix -L develop -c true

      - name: Format
        env:
          bot_token: ${{ secrets.BOT_TOKEN }}
        if: ${{ env.bot_token != '' }}
        run: |
          nix develop -c isort . --profile black
          nix develop -c black ./
          nix develop -c treefmt -f nixfmt --no-cache

      - id: ac
        uses: stefanzweifel/git-auto-commit-action@v5
        env: 
          bot_token: ${{ secrets.BOT_TOKEN }}
        if: ${{ env.bot_token != '' }}
        with:
          commit_message: "style: isort and black"
          commit_author: GitHub Actions <actions@github.com>

      - name: Changes Detected
        if: steps.ac.outputs.changes_detected == 'true'
        run: |
            echo "Linters caused a commit.  Terminating run; tests will continue on next commit"
            exit 1        

      - name: Lint
        run: |
          nix develop -c isort --check --profile black .
          nix develop -c black --check ./
          nix develop -c flake8 ./
          nix develop -c mypy --explicit-package-bases --ignore-missing-imports ./
          nix develop -c treefmt -f nixfmt --ci

      - name: Check Title
        env:
          TITLE: ${{ github.event.pull_request.title }}
        run: nix develop -c bash .github/workflows/scripts/conventional.sh "$TITLE"

      - name: Build Test Artifacts
        run: |
          nix build .#tests

  Unit-Test:
    runs-on: smallworld-arc
    needs: Lint
    steps:
      - uses: cachix/cachix-action@v15
        with:
          name: smallworld
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - uses: actions/checkout@v4
      - name: Run Unit Tests
        run: |
          cd tests
          nix develop .. -c python3 unit.py -v
  Integration-Test:
      runs-on: smallworld-arc
      needs: Lint
      strategy:
        matrix:
          include:
            - testsuite: BlockTests
            - testsuite: BranchTestsAngr
            - testsuite: BranchTestsGhidra
            - testsuite: BranchTestsPanda
            - testsuite: BranchTestsUnicorn
            - testsuite: CallTestsAngr
            - testsuite: CallTestsGhidra
            - testsuite: CallTestsPanda
            - testsuite: CallTestsUnicorn
            - testsuite: C99AbortTests
            - testsuite: C99AbsTests
            - testsuite: C99AsctimeTests
            - testsuite: C99AtexitTests
            - testsuite: C99AtoiTests
            - testsuite: C99AtollTests
            - testsuite: C99AtolTests
            - testsuite: C99BSearchTests
            - testsuite: C99CallocTests
            - testsuite: C99ClearerrTests
            - testsuite: C99ClockTests
            - testsuite: C99CtimeTests
            - testsuite: C99DifftimeTests
            - testsuite: C99ExitTests
            - testsuite: C99FcloseTests
            - testsuite: C99FeofTests
            - testsuite: C99FflushTests
            - testsuite: C99FgetcTests
            - testsuite: C99FgetposTests
            - testsuite: C99FgetsTests
            - testsuite: C99FopenTests
            - testsuite: C99FprintfTests
            - testsuite: C99FputcTests
            - testsuite: C99FputsTests
            - testsuite: C99FreadTests
            - testsuite: C99FreeTests
            - testsuite: C99FscanfTests
            - testsuite: C99FseekTests
            - testsuite: C99FsetposTests
            - testsuite: C99FtellTests
            - testsuite: C99FwriteTests
            - testsuite: C99GetcharTests
            - testsuite: C99GetcTests
            - testsuite: C99GetenvTests
            - testsuite: C99GetsTests
            - testsuite: C99GmtimeTests
            - testsuite: C99LabsTests
            - testsuite: C99LlabsTests
            - testsuite: C99LocaltimeTests
            - testsuite: C99MallocTests
            - testsuite: C99MemcmpTests
            - testsuite: C99MemcpyTests
            - testsuite: C99MemmoveTests
            - testsuite: C99MemsetTests
            - testsuite: C99MktimeTests
            - testsuite: C99PrintfTests
            - testsuite: C99PutcharTests
            - testsuite: C99PutcTests
            - testsuite: C99PutsTests
            - testsuite: C99QSortTests
            - testsuite: C99RandTests
            - testsuite: C99ReallocTests
            - testsuite: C99RemoveTests
            - testsuite: C99RenameTests
            - testsuite: C99RewindTests
            - testsuite: C99ScanfTests
            - testsuite: C99SignalTests
            - testsuite: C99SnprintfTests
            - testsuite: C99SprintfTests
            - testsuite: C99SrandTests
            - testsuite: C99SscanfTests
            - testsuite: C99StrcatTests
            - testsuite: C99StrchrTests
            - testsuite: C99StrcmpTests
            - testsuite: C99StrcpyTests
            - testsuite: C99StrcspnTests
            - testsuite: C99StrerrorTests
            - testsuite: C99StrftimeTests
            - testsuite: C99StrlenTests
            - testsuite: C99StrncatTests
            - testsuite: C99StrncmpTests
            - testsuite: C99StrncpyTests
            - testsuite: C99StrpbrkTests
            - testsuite: C99StrrchrTests
            - testsuite: C99StrspnTests
            - testsuite: C99StrstrTests
            - testsuite: C99StrtokTests
            - testsuite: C99SystemTests
            - testsuite: C99TimeTests
            - testsuite: C99TmpfileTests
            - testsuite: C99TmpnamTests
            - testsuite: C99UngetcTests
            - testsuite: CheckedDoubleFreeTests
            - testsuite: CheckedReadTests
            - testsuite: CheckedUAFTests
            - testsuite: CheckedWriteTests
            - testsuite: ColorizerTests
            - testsuite: DelayTests
            - testsuite: DMATests
            - testsuite: DocumentationTests
            - testsuite: ElfTests
            #- testsuite: ElfCoreActuateTests
            - testsuite: ElfCoreLoadTests
            - testsuite: ExitpointTests
            - testsuite: FloatsTests
            - testsuite: FsgsbaseTests
            - testsuite: FunctionPointerTests
            - testsuite: FuzzTests
            - testsuite: LinkElfTests
            - testsuite: LinkPETests
            - testsuite: HookingTests
            - testsuite: MemhookTests
            - testsuite: PETests
            - testsuite: POSIXBasenameTests
            - testsuite: POSIXBsdSignalTests
            - testsuite: POSIXDirnameTests
            - testsuite: POSIXPthreadSigmaskTests
            - testsuite: POSIXSigactionTests
            - testsuite: POSIXSigaddsetTests
            - testsuite: POSIXSigdelsetTests
            - testsuite: POSIXSigemptysetTests
            - testsuite: POSIXSigfillsetTests
            - testsuite: POSIXSigpendingTests
            - testsuite: POSIXSigprocmaskTests
            - testsuite: RelaTests
            - testsuite: RTOSDemoTests
            - testsuite: SquareTests
            - testsuite: StackTests
            - testsuite: StrlenTests
            - testsuite: StructureTests
            - testsuite: SyscallTests
            - testsuite: SysVModelTests
            - testsuite: TraceExecutionTests
            - testsuite: ThumbTests
            - testsuite: UnmappedTests
      steps:
      - uses: cachix/cachix-action@v15
        with:
          name: smallworld
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - uses: actions/checkout@v4
      - name: Build Artifacts
        run: |
          nix build .#tests
          tar -C tests -xvf result/test_binaries.tar
      - name: Run Integration Tests
        run: |
          cd tests
          nix develop .. -c python3 integration.py -v ${{ matrix.testsuite }}
  Results:
    runs-on: smallworld-arc
    needs: [Lint, Unit-Test, Integration-Test]
    if: always()
    steps:
      - name: Formatter committed â€“ new run will verify
        if: needs.Lint.outputs.changes_detected == 'true'
        run: exit 1

      - name: All tests OK
        if: needs.Lint.outputs.changes_detected != 'true' && !contains(needs.*.result, 'failure')
        run: exit 0

      - name: Tests Failed
        if: needs.Lint.outputs.changes_detected != 'true' && contains(needs.*.result, 'failure')
        run: exit 1
      
