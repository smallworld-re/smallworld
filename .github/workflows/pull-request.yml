name: Pull Request
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopen, edited]

env:
  REGISTRY: harbor.harbor.svc.cluster.local
  TZ: UTC
  SCRATCH: /home/runner/_shared

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  # cancel-in-progress: true

jobs:
  Lint:
    runs-on: smallworld-arc
    permissions:
      contents: write
    outputs:
      changes_detected: ${{ steps.ac.outputs.changes_detected }}

    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.BOT_TOKEN }}

      - name: Install Lint Tools
        run: |
          pip install --upgrade pip
          pip install $(grep isort= constraints.txt)
          pip install $(grep black= constraints.txt)
          pip install $(grep flake8= constraints.txt)
          pip install $(grep mypy= constraints.txt)

      - name: Format
        run: |
          isort . --profile black
          black ./

      - id: ac
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: isort and black"
          commit_author: GitHub Actions <actions@github.com>

      - name: Lint
        if: steps.ac.outputs.changes_detected == 'false'
        run: |
          isort --check --profile black .
          black --check ./
          flake8 ./
          mypy --explicit-package-bases --ignore-missing-imports ./

      - name: Check Title
        if: steps.ac.outputs.changes_detected == 'false'
        env:
          TITLE: ${{ github.event.pull_request.title }}
        run: bash .github/workflows/scripts/conventional.sh "$TITLE"

      - name: Build Artifacts
        if: steps.ac.outputs.changes_detected == 'false'
        run: |
          cd tests
          make -j$(nproc)
          cd elf_core
          make -j$(nproc)

      - name: Save Repo
        if: steps.ac.outputs.changes_detected == 'false'
        run: |
          cd ..
          tar cfz smallworld_${{ github.sha }}.tar.gz smallworld/
          mv smallworld_${{ github.sha }}.tar.gz $SCRATCH

  Unit-Test:
    runs-on: smallworld-arc
    needs: Lint
    if: needs.Lint.outputs.changes_detected == 'false'
    steps:
      - name: Copy Repo
        run: |
          cp $SCRATCH/smallworld_${{ github.sha }}.tar.gz .
          tar xf smallworld_${{ github.sha }}.tar.gz
      - name: Run Unit Tests
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          cd smallworld/
          pip install -e .[development] -c constraints.txt
          cd tests
          python3 unit.py

  Integration-Test-Angr:
    runs-on: smallworld-arc
    needs: Lint
    if: needs.Lint.outputs.changes_detected == 'false'
    strategy:
      matrix:
        testsuite:
          - BranchTests
          - CallTests
          - DMATests
          - ElfTests
          - FloatsTests
          - LinkElfTests
          - HookingTests
          - MemhookTests
          - PETests
          - RelaTests
          - SquareTests
          - StackTests
          - StrlenTests
          - SyscallTests
        architecture:
          - aarch64
          - amd64
          - armel
          - armhf
          - i386
          - mips
          - mipsel
          - mips64
          - mips64el
          - ppc
          - ppc64
          - riscv64
          - xtensa
        emulator: 
          - angr
        exclude:
          - testsuite: FloatsTests
            architecture: armel
          - testsuite: FloatsTests
            architecture: mips
          - testsuite: FloatsTests
            architecture: mipsel
          - testsuite: FloatsTests
            architecture: mips64
          - testsuite: FloatsTests
            architecture: mips64el
          - testsuite: FloatsTests
            architecture: ppc
          - testsuite: FloatsTests
            architecture: ppc64
          - testsuite: FloatsTests
            architecture: riscv64
          - testsuite: FloatsTests
            architecture: xtensa
          - testsuite: LinkElfTests
            architecture: ppc64
          - testsuite: LinkElfTests
            architecture: xtensa
          - testsuite: LinkElfTests
            architecture: ppc64
          - testsuite: LinkElfTests
            architecture: xtensa
        include:
          - testsuite: PETests
            architecture: amd64
          - testsuite: PETests
            architecture: i386 
    steps:
      - name: Copy Repo
        run: |
          cp $SCRATCH/smallworld_${{ github.sha }}.tar.gz .
          tar xf smallworld_${{ github.sha }}.tar.gz
      - name: Run Integration Tests
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          cd smallworld/
          pip install -e .[development] -c constraints.txt
          cd tests
          python3 integration.py -v ${{ matrix.testsuite }}.test_${{ matrix.architecture }}_${{ matrix.emulator }}

  Integration-Test-Ghidra:
    runs-on: smallworld-arc
    needs: Lint
    if: needs.Lint.outputs.changes_detected == 'false'
    strategy:
      matrix:
        testsuite:
          - BranchTests
          - CallTests
          - DMATests
          - ElfTests
          - FloatsTests
          - LinkElfTests
          - HookingTests
          - MemhookTests
          - PETests
          - RelaTests
          - SquareTests
          - StackTests
          - StrlenTests
        architecture:
          - aarch64
          - amd64
          - armel
          - armhf
          - i386
          - mips
          - mipsel
          - mips64
          - mips64el
          - ppc
          - ppc64
          - riscv64
          - xtensa
        emulator:
          - ghidra
        exclude:
          - testsuite: FloatsTests
            architecture: armel
          - testsuite: FloatsTests
            architecture: mips
          - testsuite: FloatsTests
            architecture: mipsel
          - testsuite: FloatsTests
            architecture: mips64
          - testsuite: FloatsTests
            architecture: mips64el
          - testsuite: FloatsTests
            architecture: ppc
          - testsuite: FloatsTests
            architecture: ppc64
          - testsuite: FloatsTests
            architecture: riscv64
          - testsuite: FloatsTests
            architecture: xtensa
          - testsuite: LinkElfTests
            architecture: ppc64
          - testsuite: LinkElfTests
            architecture: xtensa
          - testsuite: LinkElfTests
            architecture: ppc64
          - testsuite: LinkElfTests
            architecture: xtensa
        include:
          - testsuite: PETests
            architecture: amd64
          - testsuite: PETests
            architecture: i386 
    steps:
      - name: Copy Repo
        run: |
          cp $SCRATCH/smallworld_${{ github.sha }}.tar.gz .
          tar xf smallworld_${{ github.sha }}.tar.gz
      - name: Run Integration Tests
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          cd smallworld/
          pip install -e .[development] -c constraints.txt
          cd tests
          python3 integration.py -v ${{ matrix.testsuite }}.test_${{ matrix.architecture }}_${{ matrix.emulator }}
  
  Integration-Test-Panda:
    runs-on: smallworld-arc
    needs: Lint
    if: needs.Lint.outputs.changes_detected == 'false'
    strategy:
      matrix:
        testsuite:
          - BranchTests
          - CallTests
          - DMATests
          - ElfTests
          - LinkElfTests
          - HookingTests
          - MemhookTests
          - PETests
          - RelaTests
          - SquareTests
          - StackTests
          - StrlenTests
        architecture:
          - aarch64
          - amd64
          - armel
          - armhf
          - i386
          - mips
          - mipsel
          - mips64
          - mips64el
          - ppc
          - ppc64
          - riscv64
          - xtensa
        emulator:
          - panda
        exclude:
          - testsuite: FloatsTests
            architecture: armel
          - testsuite: FloatsTests
            architecture: mips
          - testsuite: FloatsTests
            architecture: mipsel
          - testsuite: FloatsTests
            architecture: mips64
          - testsuite: FloatsTests
            architecture: mips64el
          - testsuite: FloatsTests
            architecture: ppc
          - testsuite: FloatsTests
            architecture: ppc64
          - testsuite: FloatsTests
            architecture: riscv64
          - testsuite: FloatsTests
            architecture: xtensa
          - testsuite: LinkElfTests
            architecture: ppc64
          - testsuite: LinkElfTests
            architecture: xtensa
          - testsuite: LinkElfTests
            architecture: ppc64
          - testsuite: LinkElfTests
            architecture: xtensa
        include:
          - testsuite: BlockTests
            architecture: amd64
          - testsuite: PETests
            architecture: amd64
          - testsuite: PETests
            architecture: i386 
    steps:
      - name: Copy Repo
        run: |
          cp $SCRATCH/smallworld_${{ github.sha }}.tar.gz .
          tar xf smallworld_${{ github.sha }}.tar.gz
      - name: Run Integration Tests
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          cd smallworld/
          pip install -e .[development] -c constraints.txt
          cd tests
          python3 integration.py -v ${{ matrix.testsuite }}.test_${{ matrix.architecture }}_${{ matrix.emulator }}
  
  Integration-Test-Unicorn:
    runs-on: smallworld-arc
    needs: Lint
    if: needs.Lint.outputs.changes_detected == 'false'
    strategy:
      matrix:
        testsuite:
          - BranchTests
          - CallTests
          - DMATests
          - ElfTests
          - FloatsTests
          - FuzzTests
          - LinkElfTests
          - HookingTests
          - MemhookTests
          - PETests
          - RelaTests
          - SquareTests
          - StackTests
          - StrlenTests
        architecture:
          - aarch64
          - amd64
          - armel
          - armhf
          - i386
          - mips
          - mipsel
          - mips64
          - mips64el
          - ppc
          - ppc64
          - riscv64
          - xtensa
        emulator:
          - unicorn
        exclude:
          - testsuite: FloatsTests
            architecture: armel
          - testsuite: FloatsTests
            architecture: armhf
          - testsuite: FloatsTests
            architecture: mips
          - testsuite: FloatsTests
            architecture: mipsel
          - testsuite: FloatsTests
            architecture: mips64
          - testsuite: FloatsTests
            architecture: mips64el
          - testsuite: FloatsTests
            architecture: ppc
          - testsuite: FloatsTests
            architecture: ppc64
          - testsuite: FloatsTests
            architecture: riscv64
          - testsuite: FloatsTests
            architecture: xtensa
          - testsuite: LinkElfTests
            architecture: ppc64
          - testsuite: LinkElfTests
            architecture: xtensa
          - testsuite: LinkElfTests
            architecture: ppc64
          - testsuite: LinkElfTests
            architecture: xtensa
        include:
          - testsuite: BlockTests
            architecture: amd64
          - testsuite: PETests
            architecture: amd64
          - testsuite: PETests
            architecture: i386 
    steps:
      - name: Copy Repo
        run: |
          cp $SCRATCH/smallworld_${{ github.sha }}.tar.gz .
          tar xf smallworld_${{ github.sha }}.tar.gz
      - name: Run Integration Tests
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          cd smallworld/
          pip install -e .[development] -c constraints.txt
          cd tests
          python3 integration.py -v ${{ matrix.testsuite }}.test_${{ matrix.architecture }}_${{ matrix.emulator }}
  
  Extra-Test:
    # Extra functionality tests
    # Runs full test suites; these are all small, and don't have a consistent nomenclature
    runs-on: smallworld-arc
    needs: Lint
    if: needs.Lint.outputs.changes_detected == 'false'
    strategy:
      matrix:
        testsuite:
          - ColorizerTests
          - DocumentationTests
          - ElfCoreTests
          - RTOSDemoTests
          - StructureTests
          - SymbolicTests
          - TraceExecutionTests
    steps:
      - name: Copy Repo
        run: |
          cp $SCRATCH/smallworld_${{ github.sha }}.tar.gz .
          tar xf smallworld_${{ github.sha }}.tar.gz
      - name: Run Integration Tests
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          cd smallworld/
          pip install -e .[development] -c constraints.txt
          cd tests
          python3 integration.py -v ${{ matrix.testsuite }}
  
  Library-Test:
    # Library model test suite
    # Test cases are defined as {testsuite}.test_{architecture}
    runs-on: smallworld-arc
    needs: Lint
    if: needs.Lint.outputs.changes_detected == 'false'
    strategy:
      matrix:
        testsuite:
          - C99AbortTests
          - C99AbsTests
          - C99AsctimeTests
          - C99AtexitTests
          - C99AtoiTests
          - C99AtollTests
          - C99AtolTests
          - C99CallocTests
          - C99ClearerrTests
          - C99ClockTests
          - C99CtimeTests
          - C99DifftimeTests
          - C99ExitTests
          - C99FcloseTests
          - C99FeofTests
          - C99FflushTests
          - C99FgetcTests
          - C99FgetposTests
          - C99FgetsTests
          - C99FopenTests
          - C99FprintfTests
          - C99FputcTests
          - C99FputsTests
          - C99FreadTests
          - C99FreeTests
          - C99FscanfTests
          - C99FseekTests
          - C99FsetposTests
          - C99FtellTests
          - C99FwriteTests
          - C99GetcharTests
          - C99GetcTests
          - C99GetenvTests
          - C99GetsTests
          - C99GmtimeTests
          - C99LabsTests
          - C99LlabsTests
          - C99LocaltimeTests
          - C99MallocTests
          - C99MemcmpTests
          - C99MemcpyTests
          - C99MemmoveTests
          - C99MemsetTests
          - C99MktimeTests
          - C99PrintfTests
          - C99PutcharTests
          - C99PutcTests
          - C99PutsTests
          - C99RandTests
          - C99ReallocTests
          - C99RemoveTests
          - C99RenameTests
          - C99RewindTests
          - C99ScanfTests
          - C99SignalTests
          - C99SnprintfTests
          - C99SprintfTests
          - C99SrandTests
          - C99SscanfTests
          - C99StrcatTests
          - C99StrchrTests
          - C99StrcmpTests
          - C99StrcpyTests
          - C99StrcspnTests
          - C99StrerrorTests
          - C99StrftimeTests
          - C99StrlenTests
          - C99StrncatTests
          - C99StrncmpTests
          - C99StrncpyTests
          - C99StrpbrkTests
          - C99StrrchrTests
          - C99StrspnTests
          - C99StrstrTests
          - C99StrtokTests
          - C99SystemTests
          - C99TimeTests
          - C99TmpfileTests
          - C99TmpnamTests
          - C99UngetcTests
          - POSIXBasenameTests
          - POSIXBsdSignalTests
          - POSIXDirnameTests
          - POSIXPthreadSigmaskTests
          - POSIXSigactionTests
          - POSIXSigaddsetTests
          - POSIXSigdelsetTests
          - POSIXSigemptysetTests
          - POSIXSigfillsetTests
          - POSIXSigpendingTests
          - POSIXSigprocmaskTests
          - SysVModelTests
    steps:
      - name: Copy Repo
        run: |
          cp $SCRATCH/smallworld_${{ github.sha }}.tar.gz .
          tar xf smallworld_${{ github.sha }}.tar.gz
      - name: Run Integration Tests
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          cd smallworld/
          pip install -e .[development] -c constraints.txt
          cd tests
          python3 integration.py -v ${{ matrix.testsuite }}

  Results:
    runs-on: smallworld-arc
    needs: [Lint, Unit-Test, Integration-Test-Angr, Integration-Test-Ghidra, Integration-Test-Panda, Integration-Test-Unicorn, Extra-Test, Library-Test]
    if: always()
    steps:
      - name: Formatter committed – new run will verify
        if: needs.Lint.outputs.changes_detected == 'true'
        run: exit 1

      - name: All tests OK
        if: needs.Lint.outputs.changes_detected == 'false' && !contains(needs.*.result, 'failure')
        run: exit 0

      - name: Tests Failed
        if: needs.Lint.outputs.changes_detected == 'false' && contains(needs.*.result, 'failure')
        run: exit 1

      - name: Cleanup
        run: rm $SCRATCH/smallworld_${{ github.sha }}.tar.gz
